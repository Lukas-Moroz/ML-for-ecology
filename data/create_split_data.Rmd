---
title: "Agriculture Land Data Seperation for Training & Testing"
author: "Sakura Takahashi"
date: "2025-08-01"
output: html_document
--- 

Run this code to create training and testing datasets with the "oahu_landsat_with_agriculture.csv" file 

Load cleaned data
```{r}
library(dplyr)
library(caret)
library(ggplot2)

# load the data from cleaned data
all_landsat <- read.csv("oahu_landsat_with_agriculture.csv")

cat("Loaded data with", nrow(all_landsat), "rows and", ncol(all_landsat), "columns\n")
cat("Agriculture distribution:\n")
print(table(all_landsat$agriculture))
```  

Create spectral indicies for the bands
```{r}
cat("Computing spectral indices...\n")

all_landsat <- all_landsat %>%
  mutate(
    # NDVI (Near_Infrared - Red) / (Near_Infrared + Red)
    ndvi = ifelse(is.finite((Near_Infrared - Red) / (Near_Infrared + Red)), 
                 (Near_Infrared - Red) / (Near_Infrared + Red), NA),
    
    # NDWI (Green - Near_Infrared) / (Green + Near_Infrared)
    ndwi = ifelse(is.finite((Green - Near_Infrared) / (Green + Near_Infrared)), 
                 (Green - Near_Infrared) / (Green + Near_Infrared), NA),
    
    # EVI Enhanced Vegetation Index
    evi = ifelse(is.finite(2.5 * ((Near_Infrared - Red) / (Near_Infrared + 6 * Red - 7.5 * Blue + 1))),
                2.5 * ((Near_Infrared - Red) / (Near_Infrared + 6 * Red - 7.5 * Blue + 1)), NA),
    
    # simple ratio
    sr = ifelse(is.finite(Near_Infrared / Red) & Red != 0, Near_Infrared / Red, NA)
  )
``` 

Define spectral indices & bands
```{r}
# define all available features
spectral_bands <- c("Coastal_Aerosol", "Blue", "Green", "Red", "Near_Infrared", 
                   "Shortwave_Infrared_1", "Shortwave_Infrared_2")

spectral_indices <- c("ndvi", "ndwi", "evi", "sr")

# all features for modeling
all_features <- c(spectral_bands, spectral_indices)

cat("Features for modeling:", paste(all_features, collapse = ", "), "\n")
```  

Clean & prepare data
```{r}
cat("Cleaning data...\n")

# clean data
all_landsat_clean <- all_landsat %>%
  filter(complete.cases(.[, all_features])) %>%
  filter(!is.na(agriculture)) %>%
  
  # ensure agriculture is a factor
  mutate(agriculture = as.factor(agriculture)) %>%
  
  # remove any infinite values
  filter_at(vars(all_of(all_features)), all_vars(is.finite(.)))

cat("Data after cleaning:", nrow(all_landsat_clean), "rows\n")
cat("Agriculture classes:", paste(levels(all_landsat_clean$agriculture), collapse = ", "), "\n")
``` 

Test a split for ag classification
```{r}
set.seed(42) 
cat("Creating train/test split for agriculture classification...\n")

# limit to manageable size if dataset is very large (this is 1000 lol)
max_samples <- 100000  
if (nrow(all_landsat_clean) > max_samples) {
  cat("Dataset is large, sampling", max_samples, "rows for faster processing...\n")
  all_landsat_clean <- all_landsat_clean %>%
    group_by(agriculture) %>%
    sample_n(min(n(), max_samples/2)) %>%  
    ungroup()
}

# create stratified split
train_indices <- createDataPartition(
  all_landsat_clean$agriculture, 
  p = 0.7,  # 70% for training
  list = FALSE
)

train_data <- all_landsat_clean[train_indices, ]
test_data <- all_landsat_clean[-train_indices, ]

# print split summary
cat("\nAGRICULTURE CLASSIFICATION SPLIT SUMMARY\n")
cat("Total samples:", nrow(all_landsat_clean), "\n")
cat("Training samples:", nrow(train_data), "\n")
cat("Testing samples:", nrow(test_data), "\n")
cat("Test proportion:", round(nrow(test_data) / nrow(all_landsat_clean), 3), "\n")

cat("\nDistribution in training set:\n")
print(table(train_data$agriculture))
cat("\nDistribution in testing set:\n")
print(table(test_data$agriculture))
``` 
Save training & testing & processed data
```{r}
cat("\nSaving datasets...\n")

write.csv(train_data, "oahu_agriculture_train_data.csv", row.names = FALSE)
cat("Saved: oahu_agriculture_train_data.csv\n")

write.csv(test_data, "oahu_agriculture_test_data.csv", row.names = FALSE)
cat("Saved: oahu_agriculture_test_data.csv\n")

write.csv(all_landsat_clean, "oahu_agriculture_full_data.csv", row.names = FALSE)
cat("Saved: oahu_agriculture_full_data.csv\n")
``` 

Do the agricultural split between ag land zones
```{r}
cat("\nCreating agriculture type classification data...\n")

# filter only ag areas and create columns
ag_only <- all_landsat_clean %>%
  filter(agriculture == "Yes") %>%
  mutate(
    ag_type = case_when(
      Cropland_and_Pasture == 1 ~ "Cropland_Pasture",
      Orchards_Groves_Vineyards == 1 ~ "Orchards_Vineyards", 
      Confined_Feeding == 1 ~ "Confined_Feeding",
      Other_Ag_Land == 1 ~ "Other_Agricultural",
      Herbaceous_Rangeland == 1 ~ "Herbaceous_Range",
      Shrub_Brush_Rangeland == 1 ~ "Shrub_Range",
      Mixed_Rangeland == 1 ~ "Mixed_Range",
      TRUE ~ "Multiple_Types"  # For pixels with multiple agriculture types
    )
  ) %>%
  mutate(ag_type = as.factor(ag_type))

cat("Agriculture types found:\n")
print(table(ag_only$ag_type))

# only proceed if we have enough samples of each type
type_counts <- table(ag_only$ag_type)
if (length(type_counts) > 1 && min(type_counts) >= 100) {
  
  # create train/test split for ag types
  ag_train_indices <- createDataPartition(
    ag_only$ag_type, 
    p = 0.7, 
    list = FALSE
  )
  
  ag_train <- ag_only[ag_train_indices, ]
  ag_test <- ag_only[-ag_train_indices, ]
  
  # save ag type data sets
  write.csv(ag_train, "oahu_ag_types_train_data.csv", row.names = FALSE)
  write.csv(ag_test, "oahu_ag_types_test_data.csv", row.names = FALSE)
  write.csv(ag_only, "oahu_ag_types_full_data.csv", row.names = FALSE)
  
  cat("Saved agriculture type classification files\n")
  cat("Agriculture type training samples:", nrow(ag_train), "\n")
  cat("Agriculture type testing samples:", nrow(ag_test), "\n")
  
} else {
  cat("Not enough samples for agriculture type classification\n")
}
``` 

Verify the datasets 
```{r}
cat("\nVERIFICATION\n")
cat("Files created:\n")
cat("- oahu_agriculture_train_data.csv (", nrow(train_data), "rows )\n")
cat("- oahu_agriculture_test_data.csv (", nrow(test_data), "rows )\n")
cat("- oahu_agriculture_full_data.csv (", nrow(all_landsat_clean), "rows )\n")

# check if files exist
files_created <- list.files(pattern = "oahu_agriculture.*\\.csv")
cat("Files found:", paste(files_created, collapse = ", "), "\n")

cat("\nDATASETS FOR RANDOM FOREST MODELING\n")
cat("Features to use:", paste(all_features, collapse = ", "), "\n")
cat("Target variable: agriculture\n")
cat("Use 'oahu_agriculture_train_data.csv' to train your model\n")
cat("Use 'oahu_agriculture_test_data.csv' to test your model\n")
``` 

